#!/usr/bin/python3
import requests
import shutil
import json
import time
import os

pe_dir = '../files/pe_dir_00227'
label_dir = '../files/label_00227'
res_file = '../result/vtv3_PEfile_00227.json'

myapi = '<your_api_key>'

if not os.path.exists(label_dir):
    os.mkdir(label_dir)

for f in os.listdir(pe_dir):
    md5 = f[11:]
    url = "https://www.virustotal.com/api/v3/files/" + md5
    headers = {
        "Accept": "application/json",
        "x-apikey": myapi
    }
    response = requests.get(url, headers=headers)
    time.sleep(14.5)

    if(response.status_code == 200): # success
        json_data = response.text.replace(" ", "").replace("\n", "")
        # writen file
        wfile = open(res_file, "a")
        wfile.write(json_data + '\n')
        wfile.close()
        shutil.move(f'{pe_dir}/VirusShare_{md5}', f'{label_dir}/VirusShare_{md5}')
    elif (response.status_code == 429): # 429 Quota Exceeded
        print("Quota Exceeded!")
        break
    elif (response.status_code == 404):
        print("Not found!")
        continue
    else:
        break