#!/usr/bin/python3
from virusshare import VirusShare
import shutil
import time
import os
from os.path import isfile, join, isdir

'''
_______________________NOTE_________________________
 MUST DELETE ../result/pe_hash_X.md5 FILE FOR FIRST RUN
'''
base_dir = '../files/'

v = VirusShare('50Dge29Ml3G243d4nYVu047OdeB4m15c')

# read hashfile
print("Available dirs:")
hash_files = [f for f in os.listdir(base_dir) if (isdir(join(base_dir, f)) and 'Virus' in join(base_dir, f))]
for file in hash_files:
    print("- " + file)
print("_________________________________________")
print("With format: VirusShare_X.md5\nEnter X:  ") 
X = input().strip()

# create pe folder for first run
if not os.path.exists(f'../files/pe_dir_{X}'):
    os.mkdir(f'../files/pe_dir_{X}')

for f in os.listdir(f"{base_dir}VirusShare_{X}/"):
    res = v.info(f[11:])
    time.sleep(14)
    filetype = res['data']['filetype']
    if('PE' not in filetype):
        os.remove(f"{base_dir}VirusShare_{X}/{f}")
        print(f"{f} is deleted")
    else:
        # save info of pe file
        print(f)
        fout = open(f'../result/pe_hash_{X}.md5', 'a')
        fout.write(str(res) + '\n')
        fout.close()

        # move file into pe_dir
        shutil.move(f"{base_dir}VirusShare_{X}/{f}", f"{base_dir}pe_dir_{X}/{f}")
