import subprocess
from os import walk
import shutil
from tkinter import COMMAND

SOURCE_FOLDER = "D:\\benignDir\\Benign" #Thư mục chứa các file apk cần phân tích
RUN_FOLDER = "D:\\benignDir\\Benign\\run" #Thư mục để chạy file apk (đường dẫn khi mount volume khi chạy docker)
DONE_FOLDER = "D:\\benignDir\\Benign\\done" #Thư mục chứa các file apk đã phân tích thành xông'
ERROR_FOLDER = "D:\\benignDir\\Benign\\error" #Thư mục chứa các file apk đã phân tích lỗi
DOCKER_IMAGE = "91088ba905756b96525ab73a188f4f59432c11b3c64c34bdf189cbd40c477f10"
COMMAND = 'docker start -a -i ' + DOCKER_IMAGE

def run_docker(file_name):
    try:
        # Chạy phân tích 1 file apk
        subprocess.check_output(COMMAND, shell=True)
 
        # Move file đã phân tích thành công sang thư mục DONE_FOLDER
        old_path = RUN_FOLDER + "\\samples\\" + file_name
        new_path = DONE_FOLDER + "\\" + file_name
        shutil.move(old_path, new_path)
    except:
        # Move file phân lỗi vào rhuw mục ERROR_FOLDER
        old_path = RUN_FOLDER + "\\samples\\" + file_name
        new_path = ERROR_FOLDER + "\\" + file_name
        shutil.move(old_path, new_path)

sources = next(walk(SOURCE_FOLDER), (None, None, []))[2] #Lấy các files trong thư mục sources
for file_name in sources:
    print(file_name)
    # Move 1 file ở SOURCE_FOLDER sang RUN_FOLDER để phân tích
    old_path = SOURCE_FOLDER + "\\" + file_name
    new_path = RUN_FOLDER + "\\" + file_name
    shutil.move(old_path, new_path)
    #Chạy phân tích
    run_docker(file_name)